<template>
    <div class="d-flex justify-content-center align-items-center container">
      <% include ActionView::Helpers %>
      <div class="markdown" id="post_form">
        <form class="new_post" style="display: block;">
          <div class="form-group text-center align-items-center justify-content-center">
            <label class="control-label">
              <%= t('titles.posts.title') %>
            </label>
            <input class="form-control" type="text" v-model="post.title" id="post_title">
            <div class="form-group text-center align-items-center justify-content-center">
              <label class="control-label" for="post_body"><%= t('titles.posts.body') %></label>
              <textarea class="form-control" v-model="post.body" id="post_body"></textarea>
            </div>
            <div v-for="(attachment, index) in post.attachments_attributes"
                              class="attachments"
                              :attachment="attachment"
                              :key="index">
              <div>
                <div class="custom-file">
                  <input type="file"
                         class="custom-file-input"
                         :id="`post_attachment_${index}`"
                         @change="onImageSelected($event, attachment)">
                  <label class="custom-file-label">
                    {{ fileLabel(attachment) }}
                  </label>
                </div>
                <button class="btn btn-sm btn-small btn-danger remove_file">
                  <%= t('titles.attachments.delete') %>
                </button>
              </div>
            </div>
            <button class="btn btn-sm btn-dark add_post_attachment" id="add_file" @click.prevent="addAttachment">
              <%= t('titles.attachments.add') %>
            </button>
            <div class="form-group">
              <button class="btn btn-success" @click.prevent="createPost">
                <%= t('titles.posts.create') %>
              </button>
              <button class="btn btn-danger cancel-btn" @click.prevent="$store.commit('createAdminPostFormHide')">
                <%= t('cancel') %>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
</template>

<script>
  import objectToFormData from '../../shared/object_to_form_data';
  import { eventBus } from '../../vue_settings';

  export default {
    data() {
      return {
        post: {
          attachments_attributes: [],
        },
      };
    },
    mounted() {
      $('#post_body').markItUp(this.$store.state.myHtmlSettings);
    },
    methods: {
      createPost() {
        const post = objectToFormData(this.post, null, 'post');
        this.$http.post('/admin/posts', post).then((response) => {
          eventBus.$emit('postCreated', response.data.post);
          this.$store.commit('createAdminPostFormHide');
        },
         (response) => {
          console.log(response);
        });
      },
      addAttachment() {
        this.post.attachments_attributes.push({
          id: null,
          file: '',
          _destroy: null,
        });
      },
      onImageSelected(event, attachment) {
        attachment.file = event.target.files[0];
      },
      fileLabel(attachment) {
        return attachment.file ? attachment.file.name : 'Choose your image';
      },
    },
  };
</script>

<style scoped>

</style>
